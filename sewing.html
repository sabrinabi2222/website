<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sewing ‚Äì Made by Goo</title>
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header>
    <div class="marquee"><span>üßµ made by goo ‚úÇÔ∏è</span></div>
    <h1>Sewing Projects</h1>
    <nav>
      <a href="index.html">About</a>
      <a href="sewing.html">Sewing</a>
      <a href="photography.html">Photography</a>
    </nav>
  </header>
  <main>

    <div id="projects">
      <p class="muted">Loading‚Ä¶</p>
    </div>
  </main>
  <script>
    // One observer to auto-play/pause videos by visibility
    const videoObserver = new IntersectionObserver((entries) => {
      for (const e of entries) {
        const v = e.target;
        if (e.isIntersecting) {
          v.play().catch(() => { });
        } else {
          v.pause();
          v.currentTime = 0;
        }
      }
    }, { threshold: 0.6 }); // play when ~60% visible

    // Convert simple Markdown links + plain URLs in captions to clickable <a> tags
    function captionToHTML(s = "") {
      // escape HTML first
      let html = s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      // [text](https://url)
      html = html.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,
        '<a href="$2" target="_blank" rel="noopener">$1</a>');
      // bare URLs ‚Üí links
      html = html.replace(/(^|\s)(https?:\/\/[^\s<]+)/g,
        '$1<a href="$2" target="_blank" rel="noopener">$2</a>');
      return html;
    }

    function displayImageUrl(u) {
      // insert Cloudinary transform so HEIC/HEIF ‚Üí browser-friendly format
      return u.includes("/image/upload/")
        ? u.replace("/image/upload/", "/image/upload/f_auto,q_auto/")
        : u;
    }
    // Transcode to SDR H.264 MP4 and cap size so the browser doesn't struggle
    function displayVideoUrl(u, w = 720) {
      if (!u.includes('/video/upload/')) return u;
      return u.replace(
        '/video/upload/',
        `/video/upload/e_volume:mute,c_limit,w_${w},fps_30,br_1m,q_auto:good,vc_h264,f_mp4/`
      );
    }

    // Build a poster from 1s into the video, scaled to match
    function posterFromCloudinaryVideo(u, w = 720) {
      if (!u.includes('/video/upload/')) return '';
      const [left, right] = u.split('/video/upload/');
      const parts = right.split('/');
      const last = parts.pop();
      const baseNoQuery = last.split('?')[0];
      const basename = baseNoQuery.replace(/\.[^.]+$/, '');
      const path = parts.length ? parts.join('/') + '/' : '';
      return `${left}/video/upload/so_1,c_limit,w_${w},f_jpg,q_auto/${path}${basename}.jpg`;
    }
    (async function () {
      const res = await fetch('sewing.json', { cache: 'no-store' });
      const data = await res.json();

      // data: { order?:[], projects:{ slug: { caption?, title?, items:[{url,type}] } } }
      const projectsData = data.projects || {};
      const order = data.order || Object.keys(projectsData).sort((a, b) => a.localeCompare(b));



      const container = document.getElementById('projects');
      container.innerHTML = '';

      for (const projectKey of order) {
        const meta = projectsData[projectKey] || {};
        const items = meta.items || [];
        const title = meta.title || "";
        const caption = meta.caption || "";

        const section = document.createElement('section');
        section.className = 'project';

        const wrap = document.createElement('div');
        wrap.className = 'project-wrap';

        // Left column: caption-only with vertical bar
        const aside = document.createElement('aside');
        aside.className = 'project-aside caption-only';

        const p = document.createElement('p');
        p.className = 'project-caption';
        // use caption from JSON; if empty, fall back to a pretty version of the slug
        const captionText = caption || projectKey.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        p.innerHTML = captionToHTML(captionText);

        aside.appendChild(p);


        const grid = document.createElement('div');
        grid.className = 'gallery gallery--retro';



        for (const item of items) {
          const card = document.createElement('figure');
          card.className = 'card retro-card';

          if (item.type === 'video') {
            const v = document.createElement('video');
            v.className = 'hover-video';
            v.muted = true; v.playsInline = true; v.loop = true; v.preload = 'metadata';
            v.controls = false;
            v.poster = posterFromCloudinaryVideo(item.url);
            v.src = (typeof displayVideoUrl === 'function') ? displayVideoUrl(item.url) : item.url;
            v.addEventListener('loadedmetadata', () => {
              if (v.videoWidth && v.videoHeight) v.style.aspectRatio = `${v.videoWidth} / ${v.videoHeight}`;
            });
            card.appendChild(v);
            videoObserver.observe(v);
          } else {
            const img = document.createElement('img');
            img.loading = 'lazy';
            img.src = displayImageUrl(item.url);
            img.alt = projectKey;
            card.appendChild(img);
          }
          grid.appendChild(card);
        }

        wrap.appendChild(aside);
        wrap.appendChild(grid);
        section.appendChild(wrap);
        container.appendChild(section);
      }
    })();
  </script>
  <script>
    // ‚ú® normal cursor + sparkle trail
    (function () {
      const canHover = matchMedia('(hover:hover)').matches;
      const reduced = matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (!canHover || reduced) return; // no trail on touch or reduced-motion

      // choose your sparkle characters (mix & match, or keep one)
      const SHAPES = ['‚úß', '‚ú¶', '‚òÖ', '‚ú∫']; // swap in '‚ô•' if you want hearts sometimes
      let last = 0;
      const MIN_MS = 40; // rate limit spawns

      document.addEventListener('mousemove', (e) => {
        const now = performance.now();
        if (now - last < MIN_MS) return;
        last = now;

        const s = document.createElement('span');
        s.className = 'spark';
        s.textContent = SHAPES[Math.floor(Math.random() * SHAPES.length)];

        // random tiny rotation/size so it feels lively
        const rot = (Math.random() * 20 - 10).toFixed(1);
        const scale = 0.9 + Math.random() * 0.3;

        s.style.left = e.clientX + 'px';
        s.style.top = e.clientY + 'px';
        s.style.transform = `translate(-50%, -50%) scale(${scale}) rotate(${rot}deg)`;

        document.body.appendChild(s);
        // clean up after animation
        setTimeout(() => s.remove(), 750);
      }, { passive: true });
    })();
  </script>
  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" hidden aria-hidden="true">
    <div class="lightbox-backdrop"></div>
    <div class="lightbox-dialog" role="dialog" aria-modal="true" aria-label="Media preview">
      <button class="lightbox-close" aria-label="Close">√ó</button>
      <div class="lightbox-body"></div>
    </div>
  </div>
  <script>
    // --- Cloudinary larger transforms for the lightbox ---
    function largeImageUrl(u) {
      return u.includes("/image/upload/")
        ? u.replace("/image/upload/", "/image/upload/f_auto,q_auto,w_1600/")
        : u;
    }
    function largeVideoUrl(u) {
      return u.includes('/video/upload/')
        ? u.replace(
          '/video/upload/',
          '/video/upload/e_volume:mute,c_limit,w_1280,fps_30,br_2m,q_auto:good,vc_h264,f_mp4/'
        )
        : u;
    }

    // --- Lightbox controls ---
    const lb = document.getElementById('lightbox');
    const lbBody = lb.querySelector('.lightbox-body');
    const lbClose = lb.querySelector('.lightbox-close');

    function openLightboxFrom(el) {
      lbBody.innerHTML = "";
      // pause grid videos so audio doesn't clash
      document.querySelectorAll('.gallery video').forEach(v => v.pause());

      if (el.tagName === 'IMG') {
        const big = new Image();
        big.className = 'lightbox-media';
        big.alt = el.alt || "";
        big.src = largeImageUrl(el.src);
        lbBody.appendChild(big);
      } else if (el.tagName === 'VIDEO') {
        const v = document.createElement('video');
        v.className = 'lightbox-media';
        v.controls = true; v.autoplay = true; v.playsInline = true;
        v.muted = false; v.loop = false; v.preload = 'metadata';
        v.src = largeVideoUrl(el.currentSrc || el.src);
        lbBody.appendChild(v);
      }

      lb.hidden = false;
      lb.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
      lbClose.focus();
    }

    function closeLightbox() {
      // stop any playing media
      const v = lbBody.querySelector('video');
      if (v) { try { v.pause(); } catch { } }
      lbBody.innerHTML = "";
      lb.hidden = true;
      lb.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    }

    // open on click of any gallery image/video (event delegation)
    document.addEventListener('click', (e) => {
      const media = e.target.closest('.gallery img, .gallery video');
      if (media) {
        e.preventDefault();
        openLightboxFrom(media);
      }
    });

    // close handlers
    lbClose.addEventListener('click', closeLightbox);
    lb.addEventListener('click', (e) => {
      if (e.target.classList.contains('lightbox-backdrop')) closeLightbox();
    });
    document.addEventListener('keydown', (e) => {
      if (!lb.hidden && (e.key === 'Escape' || e.key === 'Esc')) closeLightbox();
    });
  </script>



</body>

</html>